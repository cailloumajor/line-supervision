# Configuration common to development and production
version: "3.7"

services:
  influx:
    image: influxdb:1.8
    environment:
      - INFLUX_RP_DURATION=7d
      - INFLUXDB_HTTP_FLUX_ENABLED=true
      - INFLUXDB_SUBSCRIBER_ENABLED=false
      - INFLUXDB_CONTINUOUS_QUERIES_ENABLED=false
    labels:
      - "dozzle.enable=true"
      - "traefik.enable=true"
      - "traefik.http.middlewares.influx-stripprefix.stripprefix.prefixes=/influx"
      - "traefik.http.middlewares.influx-stripprefix.stripprefix.forceslash=false"
      - "traefik.http.routers.influx.middlewares=influx-stripprefix@docker"
      - "traefik.http.routers.influx.rule=PathPrefix(`/influx/`)"
    volumes:
      - ./influx/start.sh:/docker-entrypoint-initdb.d/start.sh:ro
      - influxdb_data:/var/lib/influxdb

  log-viewer:
    image: amir20/dozzle:v2.1.4
    environment:
      - DOCKER_HOST=tcp://dockerproxy:2375
      - DOZZLE_BASE=/logs
      - DOZZLE_FILTER=label=dozzle.enable=true
    expose:
      - "8080"
    depends_on:
      - dockerproxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.logging.rule=PathPrefix(`/logs/`) || Path(`/logs`)"
    networks:
      - net-docker-socket
    user: 2000:2000

  opcua-bridge:
    build: ./opcua-webhmi-bridge
    environment:
      - INFLUX_HOST=influx
    labels:
      - "dozzle.enable=true"
      - "traefik.enable=true"
      - "traefik.http.middlewares.ws-stripprefix.stripprefix.prefixes=/ws"
      - "traefik.http.middlewares.ws-stripprefix.stripprefix.forceslash=false"
      - "traefik.http.routers.opcua-bridge.middlewares=ws-stripprefix@docker"
      - "traefik.http.routers.opcua-bridge.rule=PathPrefix(`/ws/`) || Path(`/ws`)"

  web:
    labels:
      - "dozzle.enable=true"
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=PathPrefix(`/`)"

  dockerproxy:
    image: tecnativa/docker-socket-proxy
    environment:
      - CONTAINERS=1
    labels:
      - "dozzle.enable=true"
    networks:
      - net-docker-socket
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  reverse-proxy:
    image: traefik:v2.2
    labels:
      - "dozzle.enable=true"
    networks:
      - net-docker-socket
    user: 2000:2000

networks:
  net-docker-socket:

volumes:
  influxdb_data:
